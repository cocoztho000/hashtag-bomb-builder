
<!doctype html>
<html>

<head>
    <title>Tag Bomb</title>

    <style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/index.css">
    <link rel="icon" href="images/tag_bomb-80-square.png">
    <script src="js/randomColor.js"></script>
    <script src="js/cookies.js"></script>
    <script src="js/search.js"></script>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/search.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300i" rel="stylesheet">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/header.css">
    <link rel="stylesheet" type="text/css" href="css/loader.css">
    <script src="js/chart.bundle.min.js"></script>
    <script src="js/Chart.min.js"></script>

    <!-- ADSense -->
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-7148824588418886",
        enable_page_level_ads: true
      });
    </script>
</head>

<body>
    <header >
        <div id="header_overlay">
            <div id="leftSide">
                <img id="icon" height="40px" src="images/tag_bomb-80-white.png" alt="name small">
                <h3>Target your audience with hashtag bombs</h3>
            </div>

            <div class="row search">
                <div id="searchContainer" class="col-sm-8 center">
                    <div class="input-group">
                        <form id="contactForm" autocomplete="off">
                            <input id="search_values" type="text" class="form-control" placeholder="Space or Comma Seperated Hashtags">
                            <span class="input-group-btn">
                                <button id="search_submit" type="submit" class="btn btn-default" type="button">Search</button>
                            </span>
                        </form>
                    </div><!-- /input-group -->
                </div><!-- /.col-lg-6 -->
            </div>
        </div>
        <div class="load-bar">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>

    </header>

    <div style="height: 75px"></div>

    <div id="infoContainer">
        <img id="infoPerson" src="images/person-blue.png">
        <p class="infoText" id="infoTextLine1">Find the hashtags your audience is using</p>
        <div id="helpContainer" style="text-align: center;">
            <div style="text-align: left; display: inline-block;">
                <p>HOW IT WORKS</p>
                <p>1. Figure out a couple tags that really represent your business</p>
                <p>2. Search those tags to find other tags that people are using</p>
                <p>3. Click the legend to filter out the tags you don't like</p>
                <p>4. Reap the rewards of better targeting your audiance :)</p>
            </div>
        </div>
    </div>
    <div id="legendContainer"></div>
    <div id="chartContainer" style="text-align: center;">
        <div id="barChartContainer">
            <canvas id="barChart"></canvas>
        </div>
        <div id="pieChartContainer">
            <canvas id="myChart" width="500" height="300"></canvas>
        </div>
        <div id="codeBlockContainer" style="text-align: center;">
            <div id="codeBlock">
                <div id="copyCodeBlock">copy</div>
                <code  id="tags"></code>
            </div>
        </div>
        <input type="text" value="Hello World" id="holdtext" style="display: none;"></input>
    </div>
    <footer style="height: 100px; background: transparent;"></footer>
    <script>

        var TAG_COOKIE_STR = "tags_disabled";
        var TAG_SEARCHED_STR = "tags_searched";

        var dataSet       = [];
        var hiddenDataSet = [];

        function getDataset(tag, onLoadCallback) {
            if (dataSet.length == 0 && hiddenDataSet.length == 0){
                console.log("Making request");
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', "http://hashtagbombbuilder.com/v1/tag/" + tag, true);
                    xhr.send();
                     
                    xhr.addEventListener("readystatechange", function(e){
                        try {
                            if (xhr.status != 200){
                                showError("There was a problem loading the data. Please reload the page and try again.");
                                return;
                            }
                            if (xhr.readyState == 4) {
                                var tagResponse = JSON.parse(xhr.responseText);
                                var backgrounds = randomColor({count: Object.keys(tagResponse).length, luminosity: 'light'});
                                var index = 0;
                                for (var key in tagResponse) {

                                    // check if the property/key is defined in the object itself, not in parent
                                    if (tagResponse.hasOwnProperty(key)) {
                                        dataSet.push({
                                            label: key,
                                            backgroundColor: backgrounds[index],
                                            data: [
                                                parseInt(tagResponse[key], 10),
                                            ]
                                        });
                                        console.log(key, tagResponse[key]);
                                        index++;
                                    }
                                }
                                showChartContainer();
                                hideLoadingBar();
                                hideInfoContainer();

                                console.log(dataSet)
                                onLoadCallback(dataSet);
                            }
                        }
                        catch(err) {
                            console.log("Error loading data" + err);
                            showError("There was a problem loading data. Please try again.");
                        }
                    }, false);
                
            } else {
                console.log(dataSet)
                onLoadCallback(dataSet);
            }
        }

        function getDatasetPie(tags, pieChartCallback) {
            getDataset(tags, function(tempDataset){
                var returnData = {
                    "labels": [],
                    "datasets": [{
                        "backgroundColor": [],
                        "data": [],
                    }]
                };

                tempDataset.forEach(function(tempData){
                    returnData["labels"].push(tempData["label"]);
                    returnData["datasets"][0]["backgroundColor"].push(tempData["backgroundColor"]);
                    returnData["datasets"][0]["data"].push(tempData["data"]);
                });
                pieChartCallback(returnData);
            });
        }

        function getDatasetTags(tags, onLoadCallback) {
            getDataset(tags, function(tempDataset){
                var returnData           = {};
                //var previouslyHiddenTags = getCookieArray(TAG_COOKIE_STR);

                tempDataset.forEach(function(tempData){
                    // TODO(tom):find a way to save this in a cookie
                    // Mark the tag as hidden if its in the hidden tag cookie
                    returnData[tempData["label"]] = false //previouslyHiddenTags.includes(tempData["label"]);
                });
                onLoadCallback(returnData);
            });
        }

        var allTags = {};

        function getTagSting() {
            var tagText = "";
            var tempTag = "";

            for (var key in allTags) {
                tempTag = key;
                if(allTags[key]){
                    continue;
                }

                if (!tempTag.includes("#")){
                    tempTag = "#" + allTags[key];
                }
                tagText = tagText.concat(" " + tempTag);
            }
            return tagText;
        }

        function updateTagBlock() {
            tagText = getTagSting();
            document.getElementById('tags').innerHTML = tagText;

            // When tag block changes reset copy button
            resetCopyButton();
        }
        var allSiteCharts = [];
        var BarCharCtx = document.getElementById('barChart').getContext('2d');
        var PiChartCtx = document.getElementById("myChart").getContext('2d');
        // Override the click handler
        var defaultLegendClickHandler = Chart.defaults.global.legend.onClick;
        var weightChartOptions = {
            responsive: true,
            legendCallback: function(chart) {
                console.log(chart);
                var legendHtml = [];
                legendHtml.push('<ul id="horizontal-list">');
                for (var i=0; i<chart.data.datasets[0].data.length; i++) {
                    var tempBkndClr = myBar.data.datasets[0].backgroundColor[i];
                    legendHtml.push('<li id="' + i + '" class="legend-item">');
                    legendHtml.push('    <div style="display: inline-block" onclick="newLegendClickHandler(event, ' + '\'' + i + '\'' + ')">');
                    legendHtml.push('        <span class="chart-legend-color" style="background-color:' + tempBkndClr + '"></span>');                    
                    if (chart.data.labels[i]) {
                        legendHtml.push('        ' + chart.data.labels[i] + '</div></li>');
                    } else {
                        legendHtml.push('    </div>');
                        legendHtml.push('</li>');
                    }                                                                        
                }                                                                                  
                legendHtml.push('</ul>');                                                       
                return legendHtml.join("");                                                        
            },                                                                               
            legend: {                                                                              
                display: false,                                                                     
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        };                                                                                       

       

        // Show/hide chart by click legend
        updateDataset = function(e, datasetIndex) {
            var index = datasetIndex;
            var ci = e.view.weightChart;
            var meta = ci.getDatasetMeta(index);

            // See controller.isDatasetVisible comment
            meta.hidden = meta.hidden === null? !ci.data.datasets[index].hidden : null;

            // We hid a dataset ... rerender the chart
            ci.update();
        };

        myBar = new Chart(BarCharCtx, {
                    type: 'bar',
                    data: null,
                    options: weightChartOptions,
                });
        allSiteCharts.push(myBar);
        var pieChart = new Chart(PiChartCtx, {
                  type: 'pie',
                  options:{
                    legend:{
                      display:false,
                    }
                  },
                  data: {
                    labels: null,
                    datasets: null,
                  }
                });
        allSiteCharts.push(pieChart);

        function loadBarChart(tags){
            getDatasetPie(tags, function(barData) {
                var barChartData = {
                    labels: barData["labels"],
                    datasets: barData["datasets"],
                };
                console.log("bitches");
                console.log(myBar);

                myBar.data = barChartData;
                myBar.update();
            });
        }
        function loadTagCopy(tags){
            getDatasetTags(tags, function(tempTags){
                allTags = tempTags;
                updateTagBlock();
            });
        }

        function loadCharts(tags){
            loadBarChart(tags);

            getDatasetPie(tags, function(pieCharData) {
                var pieChartData = {
                    labels: pieCharData["labels"],
                    datasets: pieCharData["datasets"],
                };
                console.log("more bitches");
                console.log(pieChart);
                pieChart.data = pieChartData;

                // Allow For chart to be modified
                pieChart.update();
            });
            loadTagCopy(tags);
            
            generateLegend();
        }

        function generateLegend(){
            var legend = document.getElementById("legendContainer");
            legend.innerHTML=myBar.generateLegend();
        }

        function getCharts() {
            return allSiteCharts
        }

        function resetCopyButton() {
            var copyButton = document.getElementById("copyCodeBlock");
            copyButton.innerHTML = "copy";
        }

        function showLoadingBar(){
            $('.bar').css("visibility","visible");
            setInfoText("Gathering your tags");
            hideHelpContainer();
        }
        function setInfoText(text){
            document.getElementById("infoTextLine1").innerHTML=text;
            $('#infoTextLine2').css("display","none");
        }
        function hideInfoContainer(){
            $('#infoContainer').css("display","none");
        }
        function showInfoContainer(){
            $('#infoContainer').css("display","inline");
        }
        function hideHelpContainer(){
            $('#helpContainer').css("display","none");
        }
        function hideLoadingBar(){
            $('.bar').css("visibility","hidden");
        }
        function showChartContainer(){
            $('#chartContainer').css("visibility","visible");
            $('#legendContainer').css("visibility","visible");
        }
        function hideChartContainer(){
            $('#chartContainer').css("visibility","hidden");
            $('#legendContainer').css("visibility","hidden");
        }


        function showError(errorStr){
            hideLoadingBar();
            hideHelpContainer();
            hideChartContainer();
            showInfoContainer();
            setInfoText(errorStr);
        }

        function newLegendClickHandler(e, legendItemIndex) {
            console.log("INDEX: " + legendItemIndex);
            var index = legendItemIndex;

            var tagName = "";
            var tagHidden = false;

            // Loop through all charts and upate them when legend is clicked
            getCharts().forEach(function(siteChart) {
                if (siteChart != null){
                    console.log(pieChart.data.labels);
                    var tagName = pieChart.data.labels[legendItemIndex];
                    console.log("CLICK LEGEND" + tagName);
                    // POP TAG OUT OF dataSet
                    if (siteChart.config.type === "bar"){
                        var found = false;
                        var item;

                        // Delete the item from the graph
                        for (var i=0; i <dataSet.length; i++) {
                            item = dataSet[i];

                            console.log(item);
                            if (item.label == tagName) {
                                found = true;
                                // Pop item and put it in hiddenDataSet
                                hiddenDataSet.push(dataSet.splice(i,1)[0]);
                                break;
                            }
                        }

                        // Add the item back to the graph
                        if (!found){
                            for (var i=0; i <hiddenDataSet.length; i++) {
                                item = hiddenDataSet[i];
                                if (item.label == tagName) {
                                    // Pop item and put it in dataSet
                                    dataSet.push(hiddenDataSet.splice(i,1)[0]);
                                    break;
                                }
                            }
                        }
                        // Update the bar char with the new data. We can't call myBar.Update()
                        // since we are hacking the bar chart library to hold 1 dataset but allow
                        // us to modify the data in a legend
                        loadBarChart("");
                    }
                    if (siteChart.config.type === "pie"){
                        var hideData = !siteChart.legend.legendItems[index].hidden;
                        tagHidden = hideData

                        console.log("pie chart");
                        siteChart.getDatasetMeta(0).data[index].hidden = hideData;
                    }
                    console.log(siteChart)
                    siteChart.update();
                }
            });
            if (tagName != ""){
                allTags[tagName] = tagHidden

            }
            loadTagCopy();
        }

        function searchContainerBadCaracter(tempSearchText){
            badChars = ['!', '$', '%', '^', '&', '*', '+', '.'];
            for (badChar of badChars){
                if (tempSearchText.indexOf(badChar) > -1) {
                    return "Hashtags can't contain these special characters: '" + badChars.join("', '") + "'"
                }
            }
            

            if (tempSearchText.match(/^\d/)) {
               return "Hashtags can't start with a number!"
            }
            return ""
        }

        $("#codeBlock").click(function() {
            var holdtext = document.getElementById("tags");
            var copyButton = document.getElementById("copyCodeBlock");

            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(holdtext);
            selection.removeAllRanges();
            selection.addRange(range);


            document.execCommand("copy");
            copyButton.innerHTML = "copied to clipboard";
        });

        $("#search_submit").click(function() {
            var tags = $('#search_values').val();
            if (tags == "") {
                return;
            }
            errorStr = searchContainerBadCaracter(tags);
            if (errorStr.length > 0){
                showError(errorStr);
                return;
            }

            newTags = "";
            for (var i = 0; i < tags.length; i++) {
                if (tags.charAt(i) == '#'){
                    continue;
                }
                if (tags.charAt(i) == ' ' || tags.charAt(i) == ','){
                    showError("Sorry currently we only support ONE tag at a time");
                    return
                }
                newTags += tags.charAt(i);
            }
            
            showLoadingBar();
            // Reset Dataset when new value is submited
            dataSet = [];
            hiddenDataSet = [];
             getDataset(newTags, function(data){
                loadCharts(newTags);
            });
        });

        $('#contactForm').submit(function () {
            return false;
        });

    </script>
</body>
<script src="https://cdn.ravenjs.com/3.26.4/raven.min.js" crossorigin="anonymous"></script>
<script type="text/javascript">
    Raven.config('https://1c3e3c52a50840648da0e4f14edade83@sentry.io/1247897').install();
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-122735588-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-122735588-1');
</script>
</html>
